{{ define "main" }}
{{ $allItems := site.Data.posters.items }}
{{ $subthemes := .Params.subthemes }}

<section class="hero">
  <div class="wrap">
    <p class="eyebrow">Theme</p>
    <h1>{{ .Title }}</h1>
    <p class="lead">{{ .Params.description }}</p>
  </div>
</section>

{{ if $subthemes }}
  {{/* Combined page with sub-sections */}}
  {{ $.Scratch.Set "total" 0 }}
  {{ range $subthemes }}
    {{ $subItems := where $allItems "themes" "intersect" (slice .theme) }}
    {{ $.Scratch.Set "total" (add ($.Scratch.Get "total") (len $subItems)) }}
  {{ end }}
  <section class="gallery wrap">
    <div class="section-title">
      <h2>{{ $.Scratch.Get "total" }} posters</h2>
      <p><a href="{{ "propaganda/" | relURL }}">&#8592; All themes</a></p>
    </div>
  </section>

  {{ range $subthemes }}
    {{ $subItems := where $allItems "themes" "intersect" (slice .theme) }}
    <section class="gallery wrap sub-gallery">
      <div class="sub-section-header" style="margin-bottom: 1.5rem;">
        <h3>{{ .title }}</h3>
        <p class="lead">{{ .description }}</p>
        <p class="meta">{{ len $subItems }} posters</p>
      </div>
      <div class="card-grid">
        {{ range $index, $item := $subItems }}
          {{ $image := partial "iiif-image.html" $item }}
          <article class="card reveal" style="--delay: {{ mul $index 0.06 }}s;">
            <a class="image-link" href="{{ $item.record }}" target="_blank" rel="noopener">
              <div class="image-frame">
                <img
                  src="{{ $image }}"
                  alt="{{ $item.title }}"
                  loading="lazy"
                  decoding="async"
                />
              </div>
            </a>
            <div class="card-body">
              <h3>{{ $item.title }}</h3>
              <p class="meta">{{ $item.country }} 路 {{ $item.date }}{{ with $item.artist }} 路 {{ . }}{{ end }}</p>
              <p class="summary">{{ $item.description }}</p>
              <div class="chip-row">
                {{ range $item.themes }}<a class="chip link" href="{{ printf "propaganda/%s/" (. | urlize) | relURL }}">{{ . }}</a>{{ end }}
              </div>
              {{ with $item.subjects }}<div class="chip-row">
                {{ range . }}<span class="chip">{{ . }}</span>{{ end }}
              </div>{{ end }}
            </div>
          </article>
        {{ end }}
      </div>
    </section>
  {{ end }}

{{ else }}
  {{/* Standard single-theme page */}}
  {{ $theme := .Params.theme }}
  {{ $items := where $allItems "themes" "intersect" (slice $theme) }}

  <section class="gallery wrap">
    <div class="section-title">
      <h2>{{ len $items }} posters</h2>
      <p><a href="{{ "propaganda/" | relURL }}">&#8592; All themes</a></p>
    </div>
    <div class="card-grid">
      {{ range $index, $item := $items }}
        {{ $image := partial "iiif-image.html" $item }}
        <article class="card reveal" style="--delay: {{ mul $index 0.06 }}s;">
          <a class="image-link" href="{{ $item.record }}" target="_blank" rel="noopener">
            <div class="image-frame">
              <img
                src="{{ $image }}"
                alt="{{ $item.title }}"
                loading="lazy"
                decoding="async"
              />
            </div>
          </a>
          <div class="card-body">
            <h3>{{ $item.title }}</h3>
            <p class="meta">{{ $item.country }} 路 {{ $item.date }}{{ with $item.artist }} 路 {{ . }}{{ end }}</p>
            <p class="summary">{{ $item.description }}</p>
            <div class="chip-row">
              {{ range $item.themes }}<a class="chip link" href="{{ printf "propaganda/%s/" (. | urlize) | relURL }}">{{ . }}</a>{{ end }}
            </div>
            {{ with $item.subjects }}<div class="chip-row">
              {{ range . }}<span class="chip">{{ . }}</span>{{ end }}
            </div>{{ end }}
          </div>
        </article>
      {{ end }}
    </div>
  </section>
{{ end }}

{{/* More Poster Themes cross-links */}}
{{ $otherPages := where (where site.RegularPages "Section" "propaganda") ".File.LogicalName" "!=" $.File.LogicalName }}
{{ if $otherPages }}
<section class="wrap" style="padding-top: 0; padding-bottom: 2rem;">
  <div class="section-title">
    <h2>More Poster Themes</h2>
    <p>Explore other themes in the WWI War Posters collection</p>
  </div>
  <div class="card-grid">
    {{ range $index, $page := $otherPages }}
    {{ $pTheme := $page.Params.theme }}
    {{ $pSubthemes := $page.Params.subthemes }}
    {{ $pItems := slice }}
    {{ if $pSubthemes }}
      {{ range $pSubthemes }}
        {{ $sub := where $allItems "themes" "intersect" (slice .theme) }}
        {{ $pItems = $pItems | append $sub }}
      {{ end }}
    {{ else }}
      {{ $pItems = where $allItems "themes" "intersect" (slice $pTheme) }}
    {{ end }}
    {{ $sampleItem := false }}
    {{ range first 1 $pItems }}{{ $sampleItem = . }}{{ end }}
    <a href="{{ $page.RelPermalink }}" class="theme-card reveal" style="--delay: {{ mul $index 0.08 }}s; text-decoration: none; color: inherit;">
      <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;">
        {{ if $sampleItem }}
        {{ $image := partial "iiif-image.html" $sampleItem }}
        {{ if $image }}
        <div style="height: 200px; overflow: hidden;">
          <img src="{{ $image }}" alt="{{ $page.Title }}" loading="lazy" decoding="async"
            style="width: 100%; height: 100%; object-fit: cover;" />
        </div>
        {{ end }}
        {{ end }}
        <div style="padding: 1.2rem;">
          <h3 style="margin: 0 0 0.4rem; font-family: var(--serif); font-size: 1.1rem;">{{ $page.Title }}</h3>
          <p style="margin: 0; color: var(--muted); font-size: 0.85rem;">{{ len $pItems }} posters</p>
        </div>
      </div>
    </a>
    {{ end }}
  </div>
</section>
{{ end }}
{{ end }}
